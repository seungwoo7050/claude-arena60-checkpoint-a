name: Arena60 CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg
      VCPKG_DEFAULT_TRIPLET: x64-linux
    
    steps:
    - uses: actions/checkout@v3

    - name: Cache vcpkg
      uses: actions/cache@v3
      with:
        path: |
          ${{ env.VCPKG_ROOT }}
          ~/.cache/vcpkg
        key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          vcpkg-${{ runner.os }}-

    - name: Setup vcpkg
      run: |
        if [ ! -d "${VCPKG_ROOT}" ]; then
          git clone --depth 1 https://github.com/microsoft/vcpkg.git "${VCPKG_ROOT}"
        fi
        if [ ! -f "${VCPKG_ROOT}/vcpkg" ]; then
          "${VCPKG_ROOT}/bootstrap-vcpkg.sh" -disableMetrics
        fi
        "${VCPKG_ROOT}/vcpkg" install --triplet x64-linux

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libpq-dev clang-format clang-tidy
    
    - name: Build (Release)
      run: |
        cd server
        mkdir build && cd build
        cmake -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_TOOLCHAIN_FILE="${VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake" ..
        make -j$(nproc)

    - name: Build (Debug)
      run: |
        cd server
        mkdir build-debug && cd build-debug
        cmake -DCMAKE_BUILD_TYPE=Debug \
              -DCMAKE_TOOLCHAIN_FILE="${VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake" ..
        make -j$(nproc)
  
  test:
    needs: build
    runs-on: ubuntu-22.04
    env:
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: arena60_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
    
    steps:
    - uses: actions/checkout@v3

    - name: Cache vcpkg
      uses: actions/cache@v3
      with:
        path: |
          ${{ env.VCPKG_ROOT }}
          ~/.cache/vcpkg
        key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          vcpkg-${{ runner.os }}-

    - name: Setup vcpkg
      run: |
        if [ ! -d "${VCPKG_ROOT}" ]; then
          git clone --depth 1 https://github.com/microsoft/vcpkg.git "${VCPKG_ROOT}"
        fi
        if [ ! -f "${VCPKG_ROOT}/vcpkg" ]; then
          "${VCPKG_ROOT}/bootstrap-vcpkg.sh" -disableMetrics
        fi
        "${VCPKG_ROOT}/vcpkg" install --triplet x64-linux

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libpq-dev
    
    - name: Build tests
      run: |
        cd server
        mkdir build && cd build
        cmake -DCMAKE_BUILD_TYPE=Debug \
              -DCMAKE_TOOLCHAIN_FILE="${VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake" ..
        make -j$(nproc)

    - name: Run unit tests
      run: |
        cd server/build
        ctest --output-on-failure -L unit

    - name: Run integration tests
      env:
        DATABASE_URL: postgresql://test:test@localhost:5432/arena60_test
        REDIS_URL: redis://localhost:6379
      run: |
        cd server/build
        ctest --output-on-failure -L integration
  
  lint:
    runs-on: ubuntu-22.04
    env:
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg
    
    steps:
    - uses: actions/checkout@v3

    - name: Cache vcpkg
      uses: actions/cache@v3
      with:
        path: |
          ${{ env.VCPKG_ROOT }}
          ~/.cache/vcpkg
        key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          vcpkg-${{ runner.os }}-

    - name: Setup vcpkg
      run: |
        if [ ! -d "${VCPKG_ROOT}" ]; then
          git clone --depth 1 https://github.com/microsoft/vcpkg.git "${VCPKG_ROOT}"
        fi
        if [ ! -f "${VCPKG_ROOT}/vcpkg" ]; then
          "${VCPKG_ROOT}/bootstrap-vcpkg.sh" -disableMetrics
        fi
        "${VCPKG_ROOT}/vcpkg" install --triplet x64-linux

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format clang-tidy
    
    - name: Check format
      run: |
        find server/src server/include -name '*.cpp' -o -name '*.h' | \
        xargs clang-format --dry-run --Werror
    
    - name: Run clang-tidy
      run: |
        cd server
        mkdir build && cd build
        cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
              -DCMAKE_TOOLCHAIN_FILE="${VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake" ..
        find ../src -name '*.cpp' -exec clang-tidy -p . {} \;
  
  coverage:
    needs: test
    runs-on: ubuntu-22.04
    env:
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg
    
    steps:
    - uses: actions/checkout@v3

    - name: Cache vcpkg
      uses: actions/cache@v3
      with:
        path: |
          ${{ env.VCPKG_ROOT }}
          ~/.cache/vcpkg
        key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          vcpkg-${{ runner.os }}-

    - name: Setup vcpkg
      run: |
        if [ ! -d "${VCPKG_ROOT}" ]; then
          git clone --depth 1 https://github.com/microsoft/vcpkg.git "${VCPKG_ROOT}"
        fi
        if [ ! -f "${VCPKG_ROOT}/vcpkg" ]; then
          "${VCPKG_ROOT}/bootstrap-vcpkg.sh" -disableMetrics
        fi
        "${VCPKG_ROOT}/vcpkg" install --triplet x64-linux

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libpq-dev lcov bc
    
    - name: Build with coverage
      run: |
        cd server
        mkdir build && cd build
        cmake -DCMAKE_BUILD_TYPE=Debug \
              -DCMAKE_CXX_FLAGS="--coverage" \
              -DCMAKE_TOOLCHAIN_FILE="${VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake" ..
        make -j$(nproc)

    - name: Run tests
      run: |
        cd server/build
        ctest
    
    - name: Generate coverage report
      run: |
        cd server/build
        lcov --capture --directory . --output-file coverage.info
        lcov --remove coverage.info '/usr/*' '*/tests/*' '*/vcpkg/*' --output-file coverage.info
        genhtml coverage.info --output-directory coverage
    
    - name: Upload coverage
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: server/build/coverage/
    
    - name: Check coverage threshold
      run: |
        cd server/build
        COVERAGE=$(lcov --summary coverage.info 2>&1 | grep lines | awk '{print $2}' | sed 's/%//')
        echo "Coverage: ${COVERAGE}%"
        if (( $(echo "$COVERAGE < 70" | bc -l) )); then
          echo "Coverage ${COVERAGE}% is below 70%"
          exit 1
        fi
